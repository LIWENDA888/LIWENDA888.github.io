<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超引-形近字符查询神器 - 自在造字</title>
    <meta name="description" content="字造产品展示，提供优质的字库产品和设计资源。">
    <meta name="keywords" content="字造, 字库, 字体设计, 设计导航，设计工具">
    <meta name="author" content="字造">
    <meta property="og:title" content="字造 - 专注分享字体领域优质内容">
    <meta property="og:description" content="字造工具箱，提供优质的字库产品和设计资源。">
    <link rel="icon" href="https://tc.z.wiki/autoupload/f/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20250803/gOQi/ico.ico" type="zizaoicon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* 主题颜色 - 默认浅色模式 */
            --primary-color: #FF7A00; 
            --accent-color: #FF5722;
            --text-color: #1A1A1A;
            --light-text: #666666;
            
            /* 浅色模式 - 默认浅灰色 */
            --bg-color: #F5F5F5; 
            --body-bg: #FFFFFF; 
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --user-bubble-bg: #E8E8E8;
            --ai-bubble-bg: rgba(255, 255, 255, 0.75); 
            
            /* 间距和尺寸 */
            --input-height: 50px; 
            --max-content-width: 900px;
            
            /* 阴影和圆角 */
            --soft-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04); 
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); 
            --transition-speed: 0.3s;
            --floating-radius: 24px; 
            --border-radius-large: 16px; 
            --border-radius-small: 10px; 
            --border-radius-card: 12px; 
            
            /* 底部栏高度和间距计算 */
            --footer-total-padding: 30px; 
            --floating-card-total-height: calc(var(--input-height) + var(--footer-total-padding)); 
            --copyright-area-height: 35px; /* 底部简洁版权信息高度 */
            --total-footer-height: calc(var(--floating-card-total-height) + 15px + var(--copyright-area-height)); 

            /* --- 新增/合并：顶部导航和通用样式变量 --- */
            --deep-grey: #222222;
            --light-grey: #CCCCCC;
            --accent-nav-color: #E0B973; /* 区分导航栏的强调色 */
            --nav-hover-bg: rgba(224, 185, 115, 0.1); 
            --sidebar-bg: #FFFFFF; 
            --sub-text-color: #6c7a89;
            --nav-text-color: #1a2a40; /* 导航栏文本色 */
            /* --- 新增/合并：顶部导航和通用样式变量 --- */
        }

        /* 移除 .eye-care-mode 和 .dark-mode 的 CSS 块 */
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: var(--bg-color); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            /* --- 修复：更改为与 fonts.html 统一的通用字体栈 --- */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            line-height: 1.6;
            overflow-x: hidden;
            /* 调整 body padding-top 以适应固定导航栏 */
            padding-top: calc(61px + 30px); /* 导航栏高度 + 原有的顶部间距 */
            /* 调整 body padding-bottom 以适应浮动输入框和简洁固定底部栏 */
            padding-bottom: calc(var(--total-footer-height) + 20px); 
        }
        
        a { color: var(--deep-grey); text-decoration: none; transition: color 0.3s; }

        /* 顶部栏样式 (从 fonts.html 复制) */
        .header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 5%; background-color: #FFFFFF;
            border-bottom: 1px solid var(--light-grey); 
        }

        .logo { display: block; } 
        .logo img { height: 28px; max-width: 150px; display: block; }

        .nav { display: flex; align-items: center; }
        .nav-item-dropdown { position: relative; list-style: none; margin-left: 15px; }
        
        .nav-item-dropdown > a {
            font-size: 16px; display: inline-flex; align-items: center;
            padding: 5px 10px 10px 10px; border-radius: 4px; position: relative;
        }
        
        .nav-item-dropdown > a::after {
            content: ''; position: absolute; bottom: 0; left: 50%;
            width: 50%; height: 3px; background-color: var(--accent-nav-color); 
            transform: translateX(-50%) scaleX(0); transition: transform 0.3s ease-out;
        }
        
        .nav-item-dropdown > a:hover { color: var(--deep-grey); }
        .nav-item-dropdown:hover > a::after { transform: translateX(-50%) scaleX(1); }
        
        .dropdown-menu {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(10px); 
            min-width: 150px; background-color: #FFFFFF;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); border-radius: 6px; padding: 8px 0; 
            z-index: 100; display: none; opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .nav-item-dropdown:hover .dropdown-menu {
            display: block; opacity: 1; transform: translateX(-50%) translateY(0);
        }
        
        .dropdown-menu a {
            display: block; padding: 8px 15px; font-size: 15px;
            white-space: nowrap; border-radius: 4px; margin: 0 8px;
        }

        .dropdown-menu a:hover { background-color: var(--nav-hover-bg); }

        .menu-toggle {
            display: none; background: none; border: none; font-size: 24px;
            cursor: pointer; color: var(--deep-grey); padding: 0 10px; z-index: 999; 
        }

        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 990; 
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }

        .backdrop.open { opacity: 1; visibility: visible; }
        
        /* 底部栏样式 (简洁固定版) */
        .simple-footer {
            /* 关键修改：改为 fixed 定位 */
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            padding: 10px 20px; 
            text-align: center;
            background: transparent; 
            z-index: 50; /* 位于浮动输入框下方 */
            font-size: 0.85rem;
            color: var(--light-text);
            line-height: 1.5;
        }
        
        .simple-footer a {
            color: var(--light-text);
        }
        
        .simple-footer a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }


        /* 浮动输入框相关的样式 */
        .input-footer {
            position: fixed;
            /* 定位在 fixed footer 的上方，保持 15px 间距 */
            bottom: calc(var(--copyright-area-height) + 15px); 
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px); 
            max-width: var(--max-content-width);
            background-color: var(--ai-bubble-bg);
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            padding: 15px 0 15px; 
            border-radius: var(--floating-radius); 
            box-shadow: var(--soft-shadow); 
            z-index: 100; /* 确保在 footer 上方 */
            border: 1px solid var(--border-color); 
        }

        .input-group-wrapper {
            width: 100%;
            max-width: var(--max-content-width);
            margin: 0 auto;
            padding: 0 25px;
            display: flex; 
            flex-direction: column;
            align-items: center;
        }
        
        .footer-main-row {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px; 
        }
        
        .header-logo img {
            height: 30px;
            vertical-align: middle;
        }
        
        .input-group-container {
            flex-grow: 1; 
            min-width: 0; 
            height: var(--input-height);
            display: flex;
            align-items: center;
        }

        .input-group {
            width: 100%;
            height: 100%;
            border-radius: var(--floating-radius); 
            border: 2px solid var(--border-color); 
            display: flex;
            align-items: center;
            background: var(--card-bg); 
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.18); 
        }
        
        #character-input {
            flex-grow: 1;
            border: none;
            padding: 0 15px; 
            font-size: 1.5rem;
            outline: none;
            background: transparent;
            color: var(--text-color);
            font-weight: normal;
            min-width: 50px; 
        }
        
        .search-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            padding: 0 15px; 
            height: 100%;
            cursor: pointer;
            font-size: 1.4rem;
            transition: color var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }
        .search-btn:hover {
            color: var(--accent-color);
        }
        
        .search-btn svg.icon {
            width: 1.2em; 
            height: 1.2em;
            fill: currentColor; 
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-shrink: 0; 
        }
        
        .action-button {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.3rem; 
            cursor: pointer;
            padding: 8px; 
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }

        .action-button:hover {
            color: var(--primary-color);
            background-color: var(--bg-color);
        }
        
        /* 主内容区/消息流 */
        .chat-container {
            flex-grow: 1;
            width: 100%;
            max-width: var(--max-content-width);
            margin: 0 auto;
        }
        
        .message-bubble {
            width: 100%;
            padding: 25px 20px; 
            border-bottom: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
            scroll-margin-top: calc(61px + 30px); /* 调整滚动锚点 */
        }
        
        .message-bubble:last-of-type { border-bottom: none; }
        
        .message-content-wrapper {
            max-width: var(--max-content-width);
            margin: 0 auto;
            display: flex;
            gap: 15px; 
            align-items: flex-start;
        }
        
        .message-icon {
            width: 35px; 
            height: 35px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
            overflow: hidden; 
        }
        
        .message-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .bubble-content {
            flex-grow: 1;
            padding: 18px 22px; 
            border-radius: var(--border-radius-small);
            font-size: 1.0rem; 
        }
        
        .user-bubble .bubble-content {
            background-color: var(--user-bubble-bg);
            border-radius: var(--border-radius-small); 
        }
        
        .system-bubble .bubble-content {
            background-color: var(--card-bg); 
            box-shadow: var(--card-shadow); 
            padding: 25px; 
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-color); 
        }

        .results-header {
            margin-bottom: 25px; 
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-title {
            font-size: 1.3rem; 
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .results-count {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .cards-container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(92px, 92px)); 
            gap: 18px; 
            justify-content: flex-start; 
        }
        
        .card {
            padding: 10px 5px; 
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 130px; 
            background: var(--card-bg);
            border-radius: var(--border-radius-card); 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            transition: all var(--transition-speed) ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.03); 
            box-shadow: 0 15px 25px rgba(255, 122, 0, 0.2), 0 5px 10px rgba(0, 0, 0, 0.05); 
            border-color: var(--primary-color);
        }
        
        .card-character {
            font-size: 2.7rem; 
            margin: 5px 0 5px;
            color: var(--text-color);
            font-weight: bold;
            line-height: 1;
        }
        
        .card-positions-wrapper {
            background-color: var(--bg-color);
            padding: 3px 8px; 
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            font-size: 0.7rem;
            color: var(--light-text);
            font-family: monospace;
            font-weight: bold;
        }

        .card-definition {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.9rem; 
            color: var(--accent-color);
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            line-height: 1;
            z-index: 2;
        }
        
        .card-definition:hover {
            transform: scale(1.1);
            color: var(--primary-color);
        }
        
        /* 复制通知 */
        .copy-notification {
            position: fixed;
            bottom: -50px; 
            left: 50%;
            transform: translateX(-50%); 
            opacity: 0;
            background: rgba(0,0,0,0.85); 
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: bottom 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease; 
            z-index: 1000;
        }
        
        .copy-notification.show {
            /* 调整通知栏位置，使其显示在浮动输入框上方 */
            bottom: calc(var(--total-footer-height) + 10px + var(--copyright-area-height)); 
            opacity: 1;
        }

        /* 动画和响应式 */
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ---------------------------------------------------- */
        /* 修复：将移动端断点统一为 768px (与 fonts.html 一致) */
        /* ---------------------------------------------------- */
        @media (max-width: 768px) {
            
            /* 移动端变量调整 */
            --copyright-area-height: 30px; 
            --total-footer-height: calc(var(--floating-card-total-height) + 10px + var(--copyright-area-height)); 
            
            body { 
                padding-top: calc(48px + 25px); /* 移动端导航栏高度 + 原有的顶部间距 */
                padding-bottom: calc(var(--total-footer-height) + 10px); 
            }
            
            .message-bubble {
                padding: 20px 15px;
            }
            .input-footer {
                bottom: calc(var(--copyright-area-height) + 10px); 
                width: calc(100% - 30px); 
                padding: 10px 0 10px; 
            }
            .input-group-wrapper {
                padding: 0 8px; 
            }
            .search-btn {
                padding: 0 10px;
            }
            #character-input {
                padding: 0 10px;
                font-size: 1.3rem; 
            }
            
             /* 移动端导航栏样式 (从 fonts.html 复制) */
            .header { padding: 10px 4%; }
            .menu-toggle { display: block; }
            
            .nav {
                position: fixed; top: 48px; right: 0; left: 0; width: 100%; 
                max-width: none; height: calc(100vh - 48px);
                background-color: var(--sidebar-bg); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); 
                z-index: 999; display: flex; flex-direction: column; padding: 20px 4%; 
                overflow-y: auto; 
                transform: translateY(-100%); opacity: 0; visibility: hidden;
                transition: transform 0.3s ease-out, opacity 0.3s, visibility 0s 0.3s;
            }

            .nav.open {
                transform: translateY(0); opacity: 1; visibility: visible;
                transition: transform 0.3s ease-out, opacity 0.3s; 
            }
            
            .backdrop { top: 48px; height: calc(100vh - 48px); }

            .nav-item-dropdown { margin: 0; width: 100%; border-bottom: 1px solid #eeeeee; }
            .nav-item-dropdown:last-child { border-bottom: none; }

            .nav-item-dropdown > a {
                padding: 15px 10px; font-size: 18px; width: 100%;
                display: flex; justify-content: space-between; 
            }
            
            .nav-item-dropdown > a::after { content: none; } 
            
            .nav .nav-item-dropdown .dropdown-menu {
                display: none; 
                position: static; 
                opacity: 1;
                transform: none;
                border: none !important;
                box-shadow: none !important;
            }
            
            .nav .nav-item-dropdown.open .dropdown-menu {
                display: block !important; 
            }
            
            .dropdown-menu a {
                padding: 10px 10px; font-size: 16px; margin: 3px 0;
            }
        }
        
        @media (max-width: 576px) {
            .cards-container { 
                grid-template-columns: repeat(auto-fill, minmax(75px, 75px)); 
                gap: 12px; 
            } 
            .card {
                 height: 110px; 
            }
             .card-character { font-size: 2.3rem; }
            .header-logo img {
                height: 25px; 
            }
            .action-button {
                font-size: 1.1rem; 
                padding: 6px; 
            }
            
            .simple-footer {
                 font-size: 0.8rem;
                 padding: 8px 15px; 
            }
        }
    </style>
</head>
<body>
    
    <header class="header" id="headerContainer">
    </header>

    <main class="chat-container" id="chat-container"></main>

    <div class="input-footer">
        <div class="input-group-wrapper">
            
            <div class="footer-main-row">
                 
                 <div class="header-logo">
                    <img src="https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/LU5q/538X150/1.png/webp" alt="字造Logo">
                </div>

                <div class="input-group-container">
                    <div class="input-group">
                        <input type="text" id="character-input" maxlength="1" placeholder="输入一个汉字查询形近字" autocomplete="off" aria-label="输入汉字进行查询">
                        <button id="search-btn" class="search-btn" aria-label="搜索">
                            <svg class="icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 458.6c12.5 12.5 12.5 32.75 0 45.25s-32.75 12.5-45.25 0L330.7 376c-34.46 25.12-76.81 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c88.37 0 160-71.63 160-160S296.3 32 208 32S48 103.6 48 192S119.6 352 208 352z"/></svg>
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-button" id="clear-chat-btn" aria-label="清空聊天记录" title="清空聊天记录">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    </div>
            </div>
            
        </div>
    </div>
    
    <footer id="footerContainer">
    </footer>
    
    <div class="copy-notification" id="copy-notification">已复制到剪贴板</div>

<script src="https://www.zizao.top/pages/common.js"></script>
<script src="https://www.zizao.top/pages/cy-data.js"></script>
    
<script>
    const USER_AVATAR_URL = "https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/11ox/300X300/2.png/webp"; 
    const SYSTEM_AVATAR_URL = "https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/hafo/1250X1250/1.png/webp";
    
    const DOM = {
        characterInput: document.getElementById('character-input'),
        searchBtn: document.getElementById('search-btn'),
        chatContainer: document.getElementById('chat-container'),
        copyNotification: document.getElementById('copy-notification'),
        clearChatBtn: document.getElementById('clear-chat-btn'),
        headerContainer: document.getElementById('headerContainer'), 
        footerContainer: document.getElementById('footerContainer')  
    };
    
    const definitionBaseUrl = "https://www.zdic.net/hans/%s";
    const CHAT_HISTORY_KEY = 'chatHistory';

    let copyTimeout = null; 
    let currentLoadingMessageId = null; 
    let wordMap = new Map();
    
    // --- 渲染顶部导航栏函数 (从 fonts.html 复制) ---
    function renderHeader() {
        if (!DOM.headerContainer || typeof navData === 'undefined' || typeof siteConfig === 'undefined') return;

        let navHtml = navData.map(item => {
            const isDropdown = item.hasDropdown ? 'has-dropdown' : '';
            // 默认 navData 中的链接都从新标签页打开，除非明确设置为 false 或不需要
            const targetAttr = item.openInNewTab ? ' target="_blank" rel="noopener noreferrer"' : '';

            let subMenuHtml = '';
            if (item.subMenu) {
                const subLinks = item.subMenu.map(sub => {
                    const subTargetAttr = sub.openInNewTab ? ' target="_blank" rel="noopener noreferrer"' : '';

                    return `<a href="${sub.url}" class="nav-item-sub"${subTargetAttr}>${sub.label}</a>`;
                }).join('');
                subMenuHtml = `<div class="dropdown-menu">${subLinks}</div>`;
            }

            return `
                <div class="nav-item-dropdown">
                    <a href="${item.url || '#'}" class="nav-item ${isDropdown}"${targetAttr}>${item.label}</a>
                    ${subMenuHtml}
                </div>
            `;
        }).join('');

        DOM.headerContainer.innerHTML = `
            <a href="${siteConfig.homeUrl}" class="logo">
                <img src="${siteConfig.logoUrl}" alt="品牌 LOGO" id="headerLogo">
            </a>
            <button class="menu-toggle" id="menuToggle">☰</button> 
            <div class="backdrop" id="menuBackdrop"></div>
            <nav class="nav" id="mainNav">
                ${navHtml}
            </nav>
        `;
    }

    // --- 渲染底部版权信息函数 (简洁固定版，包含链接) ---
    function renderFooter() {
        if (!DOM.footerContainer || typeof footerLinks === 'undefined' || typeof siteConfig === 'undefined') return;

        const linkHtml = footerLinks.map(link => `
            <a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.label}</a>
        `).join('<span style="margin: 0 8px;">|</span>'); // 使用 | 作为分隔符

        // 使用简洁固定样式类
        DOM.footerContainer.className = 'simple-footer'; 
        DOM.footerContainer.innerHTML = `
            <div class="footer-content">
                <span class="copyright-text">${siteConfig.copyrightText}</span> 
                <span style="margin: 0 10px;">•</span>
                <span class="footer-links">${linkHtml}</span>
            </div>
        `;
    }
    
    // --- 绑定导航栏事件函数 (从 fonts.html 复制) ---
    function bindHeaderEvents() {
        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');
        const menuBackdrop = document.getElementById('menuBackdrop'); 
        
        if (!menuToggle || !mainNav || !menuBackdrop) return;
        
        const dropdownItems = mainNav.querySelectorAll('.nav-item-dropdown');

        function closeMenu() {
            mainNav.classList.remove('open');
            menuBackdrop.classList.remove('open'); 
            document.body.style.overflow = '';
            dropdownItems.forEach(dropdown => dropdown.classList.remove('open'));
        }
        
        function toggleMenu() {
            const isOpen = mainNav.classList.toggle('open');
            menuBackdrop.classList.toggle('open'); 
            
            if (window.innerWidth <= 768) { // 修复：使用正确的移动端断点
                document.body.style.overflow = isOpen ? 'hidden' : ''; 
            }
            
            if (!isOpen) { 
                closeMenu(); 
            }
        }
        
        menuToggle.addEventListener('click', toggleMenu);
        menuBackdrop.addEventListener('click', closeMenu); 
        
        mainNav.querySelectorAll('.nav-item, .nav-item-sub').forEach(item => {
            if (!item.classList.contains('has-dropdown') || item.classList.contains('nav-item-sub')) {
                item.addEventListener('click', () => {
                    if (mainNav.classList.contains('open')) {
                        setTimeout(closeMenu, 100); 
                    }
                });
            }
        });
        
        dropdownItems.forEach(item => {
            const navLink = item.querySelector('.nav-item.has-dropdown');
            if (navLink) {
                navLink.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) { // 修复：使用正确的移动端断点
                        e.preventDefault(); 
                        const wasOpen = item.classList.contains('open');
                        dropdownItems.forEach(d => d.classList.remove('open')); 
                        if (!wasOpen) {
                            item.classList.add('open'); 
                        }
                    }
                });
            }
        });
        
        // 监听窗口大小变化，如果从移动端变为桌面端，则关闭菜单并移除 overflow: hidden
        window.addEventListener('resize', () => {
             if (window.innerWidth > 768 && mainNav.classList.contains('open')) { // 修复：使用正确的移动端断点
                closeMenu();
             }
        });
    }

    function preprocessData() {
        if (typeof customWordGroups !== 'undefined') {
            customWordGroups.forEach(wordGroup => {
                const firstChar = wordGroup.charAt(0);
                if (!wordMap.has(firstChar)) {
                    wordMap.set(firstChar, new Set());
                }
                const relatedSet = wordMap.get(firstChar);
                for (let i = 0; i < wordGroup.length; i++) {
                    relatedSet.add(wordGroup.charAt(i));
                }
            });
        } else {
            console.error("数据加载失败。请检查 data.js 文件是否正确引入。");
        }
    }
    
    function scrollToBottom() {
        setTimeout(() => {
            window.scrollTo({
                top: document.documentElement.scrollHeight, 
                behavior: 'smooth'
            });
        }, 100);
    }
    
    function loadChatHistory() {
        try {
            const history = localStorage.getItem(CHAT_HISTORY_KEY);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.error("加载聊天历史失败:", e);
            return [];
        }
    }

    function saveChatHistory(history) {
        try {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
            console.error("保存聊天历史失败:", e);
        }
    }
    
    function createMessage(type, contentHtml, id = null, isTransient = false) {
        const messageElement = document.createElement('div');
        const msgId = id || 'msg-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        messageElement.id = msgId;
        
        messageElement.classList.add('message-bubble', `${type}-bubble`);
        if (isTransient) {
            messageElement.classList.add('loading-msg');
        }

        const avatarUrl = type === 'user' ? USER_AVATAR_URL : SYSTEM_AVATAR_URL;
        
        messageElement.innerHTML = `
            <div class="message-content-wrapper">
                <div class="message-icon">
                     <img src="${avatarUrl}" alt="${type === 'user' ? '用户' : '系统'}头像">
                </div>
                <div class="bubble-content">${contentHtml}</div>
            </div>
        `;
        return messageElement;
    }

    function addMessageToDOMAndHistory(type, contentHtml, id = null, isTransient = false) {
        const messageElement = createMessage(type, contentHtml, id, isTransient);
        DOM.chatContainer.appendChild(messageElement);
        
        if (!isTransient) {
            const history = loadChatHistory();
            if (!messageElement.classList.contains('loading-msg') && id !== 'msg-instructions') {
                history.push({ type, contentHtml, id: messageElement.id });
                saveChatHistory(history);
            }
        }
        
        return messageElement;
    }
    
    function addUserMessage(char) {
        const content = `查询汉字：<strong style="font-size: 1.2em;">${char}</strong>`;
        addMessageToDOMAndHistory('user', content);
    }

    function addLoadingMessage() {
        const loadingHtml = `
            <div class="loading-bubble">
                字菌 正在努力查询中
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        `;
        const messageId = 'msg-loading-' + Date.now();
        addMessageToDOMAndHistory('system', loadingHtml, messageId, true);
        currentLoadingMessageId = messageId; 
        
        scrollToBottom(); 
        return messageId;
    }

    function removeOrReplaceLoadingMessage(contentHtml) {
        const loadingMsg = document.getElementById(currentLoadingMessageId);
        
        if (loadingMsg) {
            let history = loadChatHistory();
            const historyIndex = history.findIndex(msg => msg.id === currentLoadingMessageId);
            
            if (contentHtml) {
                loadingMsg.classList.remove('loading-msg');
                loadingMsg.innerHTML = createMessage('system', contentHtml).innerHTML; 
                
                if (historyIndex !== -1) {
                    history.splice(historyIndex, 1, { 
                        type: 'system', 
                        contentHtml: contentHtml, 
                        id: currentLoadingMessageId 
                    });
                } else {
                    history.push({ 
                        type: 'system', 
                        contentHtml: contentHtml, 
                        id: currentLoadingMessageId 
                    });
                }
                saveChatHistory(history);
            } else {
                loadingMsg.remove();
                if (historyIndex !== -1) {
                    history.splice(historyIndex, 1);
                    saveChatHistory(history);
                }
            }
        } else if (contentHtml) {
            addSystemMessage(contentHtml);
        }
        currentLoadingMessageId = null;
        scrollToBottom(); 
    }

    function addSystemMessage(contentHtml) {
        addMessageToDOMAndHistory('system', contentHtml);
    }

    function renderDefaultInstructions() {
        const instructionsHtml = `
            <div class="instructions-content" style="padding: 0;">
                <h2 class="results-title" style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                    <i class="fas fa-info-circle"></i>
                    使用说明
                </h2>
                <ol style="padding-left: 20px; margin-top: 5px; list-style-type: decimal; color: var(--light-text); font-size: 0.95rem;">
                    <li style="margin-bottom: 12px;">在底部输入框输入<strong style="color: var(--accent-color);">单个汉字</strong>，按回车或点击搜索按钮进行查询。</li>
                    <li style="margin-bottom: 12px;">每个形近字以卡片形式展示，点击卡片可复制该汉字。</li>
                    <li style="margin-bottom: 12px;">卡片下方显示该字在GB2312编码排序中的位置和页码信息。</li>
                    <li style="margin-bottom: 12px;">点击卡片右上角的信息图标可在新标签页中查看该字的详细释义。</li>
                    <li style="margin-bottom: 12px;">本页面数据由字造整理，当前包含国标GB2312全部中文字符。</li>
                </ol>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.9rem;">
                    <span style="color: var(--light-text); margin-right: 15px;">推荐:</span>
                    <a href="https://www.zizao.top" target="_blank" style="color: var(--primary-color); text-decoration: none; margin-right: 5px;">字造首页</a> |
                    <a href="https://www.zizao.top/hao" target="_blank" style="color: var(--primary-color); text-decoration: none; margin-left: 5px; margin-right: 5px;">设计导航</a>
                </div>
            </div>
        `;
        if (document.getElementById('msg-instructions')) return; 

        const msgElement = createMessage('system', instructionsHtml, 'msg-instructions', false);
        msgElement.classList.add('instructions-msg'); 
        DOM.chatContainer.appendChild(msgElement);
    }

    function renderChatHistory() {
        const history = loadChatHistory();
        DOM.chatContainer.innerHTML = ''; 
        
        renderDefaultInstructions();

        if (history.length > 0) {
            history.forEach(msg => {
                const messageElement = createMessage(msg.type, msg.contentHtml, msg.id, false);
                DOM.chatContainer.appendChild(messageElement);
            });
        }
        
        scrollToBottom();
    }
    
    function showLoading() {
        DOM.searchBtn.innerHTML = '<svg class="icon loading-spinner" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="animation: spin 1.5s linear infinite;"><path d="M448 256c0-106-86-192-192-192V32C375.7 32 480 136.3 480 264c0 13.25-10.75-24-24 24s-24-10.75-24-24C432 153.8 342.2 64 232 64v48c-106 0-192 86-192 192s86 192 192 192c47.94 0 91.22-17.75 125.7-47.5c18.5-16 45.19-14.5 61.19 4s14.5 45.19-4 61.19C340.3 499.7 299.1 512 256 512C114.6 512 0 397.4 0 256S114.6 0 256 0c13.25 0 24 10.75 24 24S269.3 48 256 48z"/></svg>';
        DOM.searchBtn.disabled = true;
        DOM.characterInput.disabled = true;
    }

    function hideLoading() {
        DOM.searchBtn.innerHTML = '<svg class="icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 458.6c12.5 12.5 12.5 32.75 0 45.25s-32.75 12.5-45.25 0L330.7 376c-34.46 25.12-76.81 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c88.37 0 160-71.63 160-160S296.3 32 208 32S48 103.6 48 192S119.6 352 208 352z"/></svg>';
        DOM.searchBtn.disabled = false;
        DOM.characterInput.disabled = false;
    }


    async function searchCharacters(isFromUrl = false) {
        
        const inputChar = DOM.characterInput.value.trim();

        if (inputChar.length !== 1 || !/^[\u4e00-\u9fa5]$/.test(inputChar)) {
             if (!isFromUrl && inputChar.length > 0) {
                addUserMessage(inputChar);
                const errorHtml = `<div class="no-results" style="text-align: center; color: var(--light-text); font-size: 1.0rem; line-height: 1.8; padding: 20px 0;">${inputChar.length > 1 ? '请输入**单个汉字**进行查询。' : '请输入**有效的汉字**。'}</div>`;
                addSystemMessage(errorHtml);
            }
            DOM.characterInput.value = '';
            DOM.characterInput.focus();
            return;
        }

        if (!isFromUrl) {
            addUserMessage(inputChar);
        }
        
        DOM.characterInput.value = '';
        showLoading();

        addLoadingMessage();
        await new Promise(resolve => setTimeout(resolve, 500)); 

        const relatedCharsSet = wordMap.get(inputChar) || new Set();
        relatedCharsSet.delete(inputChar);
        let relatedChars = Array.from(relatedCharsSet);
        
        if (wordMap.has(inputChar)) {
            relatedChars.unshift(inputChar);
        }

        let finalContentHtml = '';
        const pageSize = 500; 
        
        if (relatedChars.length === 0) {
            finalContentHtml = `
                <div class="no-results" style="text-align: center; color: var(--light-text); font-size: 1.0rem; line-height: 1.8; padding: 20px 0;">
                    抱歉，未找到“<strong style="color: var(--primary-color);">${inputChar}</strong>”的形近字。<br>
                    建议尝试查询“<strong style="color: var(--accent-color);">字</strong>”、“<strong style="color: var(--accent-color);">设</strong>”、“<strong style="color: var(--accent-color);">计</strong>”等常用字。
                </div>
            `;
        } else {
            const cardsHtml = relatedChars.map((char) => {
                const firstPosition = typeof indexGroup !== 'undefined' ? indexGroup.indexOf(char) + 1 : -1;
                const totalPosition = firstPosition > 0 ? firstPosition : '';
                const pagePosition = firstPosition > 0 ? `${Math.floor((firstPosition - 1) / pageSize) + 1}/${(firstPosition - 1) % pageSize + 1}` : '';
                
                return `
                    <div class="card" data-char="${char}">
                        <button class="card-definition" title="查看释义">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <div class="card-character">${char}</div>
                        <div class="card-positions-wrapper" title="总序/页码">
                            <div class="card-position-total">${totalPosition}</div>
                            <div class="card-position-page">${pagePosition}</div>
                        </div>
                    </div>
                `;
            }).join('');

            finalContentHtml = `
                <header class="results-header">
                    <h2 class="results-title">
                        <i class="fas fa-link"></i>
                         “${inputChar}”的形近字
                    </h2>
                    <div class="results-count">${relatedChars.length}个结果</div>
                </header>
                <div class="cards-container">${cardsHtml}</div>
            `;
        }
        
        removeOrReplaceLoadingMessage(finalContentHtml);
        
        updateUrl(inputChar);
        
        hideLoading();
        DOM.characterInput.focus(); 
    }

    function updateUrl(char) {
        const newUrl = new URL(window.location.href);
        if (char && char.length === 1 && /^[\u4e00-\u9fa5]$/.test(char)) {
            newUrl.searchParams.set('char', char);
        } else {
            newUrl.searchParams.delete('char');
        }
        window.history.pushState({ path: newUrl.href }, '', newUrl.href);
    }

    function copyToClipboard(text) {
        if (copyTimeout) {
            clearTimeout(copyTimeout);
        }
        
        DOM.copyNotification.classList.remove('show');

        navigator.clipboard.writeText(text)
            .then(() => {
                DOM.copyNotification.classList.add('show');
                
                copyTimeout = setTimeout(() => {
                    DOM.copyNotification.classList.remove('show');
                    copyTimeout = null;
                }, 1500); 
            })
            .catch(err => {
                console.error('无法复制文本: ', err);
                alert('复制失败，请手动复制。');
            });
    }
    
    function clearChat() {
        if (confirm('确定要清空所有搜索记录吗？')) {
            DOM.chatContainer.innerHTML = '';
            localStorage.removeItem(CHAT_HISTORY_KEY); 
            renderDefaultInstructions();
            updateUrl('');
            DOM.characterInput.focus();
        }
    }

    // --- 事件监听器 ---

    DOM.chatContainer.addEventListener('click', (event) => {
        const target = event.target;
        const card = target.closest('.card');
        if (card) {
            const char = card.dataset.char;
            if (target.closest('.card-definition')) {
                event.stopPropagation();
                window.open(definitionBaseUrl.replace('%s', char), '_blank');
            } else {
                copyToClipboard(char);
            }
        }
    });

    DOM.searchBtn.addEventListener('click', () => searchCharacters());
    DOM.characterInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') searchCharacters();
    });
    
    DOM.clearChatBtn.addEventListener('click', clearChat);


    // --- 初始化 ---

    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. 动态渲染公共模块
        renderHeader();
        renderFooter();
        bindHeaderEvents(); // 绑定顶部栏事件
        
        preprocessData();
        
        renderChatHistory();

        const urlChar = new URLSearchParams(window.location.search).get('char');
        if (urlChar && urlChar.length === 1 && /^[\u4e00-\u9fa5]$/.test(urlChar)) {
            const history = loadChatHistory();
            const alreadySearched = history.some(msg => msg.type === 'user' && msg.contentHtml.includes(`>${urlChar}<`));

            if (!alreadySearched) {
                 DOM.characterInput.value = urlChar; 
                 searchCharacters(true);
            } else {
                 DOM.characterInput.focus();
            }
        } else {
            DOM.characterInput.focus();
        }
    });
</script>
</body>
</html>