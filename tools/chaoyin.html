<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超引-形近字符查询神器 - 自在造字</title>
    <meta name="description" content="字造产品展示，提供优质的字库产品和设计资源。了解更多关于字造的信息。">
    <meta name="keywords" content="字造, 字库, 字体设计, 设计导航，设计工具">
    <meta name="author" content="字造">
    <meta property="og:title" content="字造 - 专注分享字体领域优质内容">
    <meta property="og:description" content="字造工具箱，提供优质的字库产品和设计资源。了解更多关于字造的信息。">
    <meta property="og:image" content="https://tc.z.wiki/autoupload/f/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20250803/9BXx/1108X308/logo.png">
    <meta property="og:url" content="https://www.zizao.top">
    <meta property="og:type" content="website">
    <link rel="icon" href="https://tc.z.wiki/autoupload/f/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20250803/gOQi/ico.ico" type="zizaoicon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* 主题颜色 */
            --primary-color: #FF7A00; 
            --accent-color: #FF5722;
            --text-color: #1A1A1A;
            --light-text: #666666;
            
            /* 浅色模式 - 默认浅灰色 */
            --bg-color: #F5F5F5; 
            --body-bg: #FFFFFF; 
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --user-bubble-bg: #E8E8E8;
            --ai-bubble-bg: rgba(255, 255, 255, 0.95); 
            
            /* 间距和尺寸 */
            --header-height: 60px; 
            --input-height: 50px; 
            --max-content-width: 900px;
            
            /* 阴影和圆角 */
            --soft-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04); 
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); 
            --transition-speed: 0.3s;
            --floating-radius: 24px; 
            --border-radius-large: 16px; 
            --border-radius-small: 10px; 
            --border-radius-card: 12px; 
        }

        /* 浅绿色护眼模式 */
        .eye-care-mode {
            --bg-color: #E6F3E6; 
            --body-bg: #F0FFF0; 
            --card-bg: rgba(255, 255, 255, 0.9); 
            --border-color: #D3EAD3;
            --user-bubble-bg: #DCE8DC;
            --ai-bubble-bg: rgba(255, 255, 255, 0.9);
            --text-color: #2F4F4F; 
        }

        /* 深色模式 */
        .dark-mode {
            --primary-color: #FF9800;
            --accent-color: #E64A19;
            --text-color: #E0E0E0;
            --light-text: #A0A0A0;
            --bg-color: #1F1F1F;
            --body-bg: #000000;
            --card-bg: #282828;
            --border-color: #404040;
            --soft-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.4), 0 2px 8px -2px rgba(0, 0, 0, 0.2);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --user-bubble-bg: #3A3A3A;
            --ai-bubble-bg: rgba(40, 40, 40, 0.95); 
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: all var(--transition-speed) ease; 
        }
        
        body {
            background: var(--bg-color); 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-color);
            font-family: "PingFang SC", "Hiragino Sans GB", "Helvetica Neue", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: calc(var(--header-height) + 30px); 
            padding-bottom: calc(var(--input-height) + 90px); 
        }

        /* SVG 图标基础样式 */
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em;
            fill: currentColor;
        }

        /* 1. 顶部导航栏/Header - 应用更大的圆角 */
        .header {
            position: fixed; 
            top: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px); 
            max-width: var(--max-content-width);
            height: var(--header-height);
            background-color: var(--ai-bubble-bg);
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            border-radius: var(--floating-radius); 
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px; 
            box-shadow: var(--soft-shadow); 
            border: 1px solid var(--border-color); 
        }
        
        /* 移动端调整顶部栏样式 */
        @media (max-width: 900px) {
            .header {
                top: 15px; 
                width: calc(100% - 30px); 
                height: 50px; 
                padding: 0 15px;
            }
            body {
                padding-top: calc(50px + 25px); 
            }
        }
        
        .header-logo img {
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .action-button {
            background: none;
            border: none;
            color: var(--light-text);
            font-size: 1.3rem; 
            cursor: pointer;
            padding: 8px; 
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }

        .action-button:hover {
            color: var(--primary-color);
            background-color: var(--bg-color);
        }

        /* 2. 主内容区/消息流 */
        .chat-container {
            flex-grow: 1;
            width: 100%;
            max-width: var(--max-content-width);
            margin: 0 auto;
        }
        
        .message-bubble {
            width: 100%;
            padding: 25px 20px; 
            border-bottom: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
            scroll-margin-top: calc(var(--header-height) + 30px); 
        }
        
        .message-bubble:last-of-type {
            border-bottom: none;
        }
        
        /* 优化：对加载完成的消息进行动画延迟，保证顺序 */
        .message-bubble:nth-child(1) { animation-delay: 0.0s; }
        .message-bubble:nth-child(2) { animation-delay: 0.1s; }
        .message-bubble:nth-child(3) { animation-delay: 0.2s; }
        .message-bubble:nth-child(4) { animation-delay: 0.3s; }
        .message-bubble:nth-child(5) { animation-delay: 0.4s; }


        .message-content-wrapper {
            max-width: var(--max-content-width);
            margin: 0 auto;
            display: flex;
            gap: 15px; 
            align-items: flex-start;
        }
        
        .message-icon {
            width: 35px; 
            height: 35px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
            overflow: hidden; 
        }
        
        .message-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .bubble-content {
            flex-grow: 1;
            padding: 18px 22px; 
            border-radius: var(--border-radius-small);
            font-size: 1.0rem; 
        }
        
        .user-bubble .bubble-content {
            background-color: var(--user-bubble-bg);
            border-radius: var(--border-radius-small); 
        }
        
        /* 系统消息气泡 - 卡片式设计 */
        .system-bubble .bubble-content {
            background-color: var(--card-bg); 
            box-shadow: var(--card-shadow); 
            padding: 25px; 
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-color); 
        }

        /* 结果展示样式 */
        .results-header {
            margin-bottom: 25px; 
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-title {
            font-size: 1.3rem; 
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .results-count {
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        /* 卡片容器 */
        .cards-container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(92px, 92px)); 
            gap: 18px; 
            justify-content: flex-start; 
        }
        
        .card {
            padding: 10px 5px; 
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 130px; 
            background: var(--card-bg);
            border-radius: var(--border-radius-card); 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            transition: all var(--transition-speed) ease-in-out;
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.03); 
            box-shadow: 0 15px 25px rgba(255, 122, 0, 0.2), 0 5px 10px rgba(0, 0, 0, 0.05); 
            border-color: var(--primary-color);
        }
        
        .card-character {
            font-size: 2.7rem; 
            margin: 5px 0 5px;
            color: var(--text-color);
            font-weight: bold;
            line-height: 1;
        }
        
        .card-positions-wrapper {
            background-color: var(--bg-color);
            padding: 3px 8px; 
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            font-size: 0.7rem;
            color: var(--light-text);
            font-family: monospace;
            font-weight: bold;
        }

        .card-definition {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.9rem; 
            color: var(--accent-color);
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            line-height: 1;
            z-index: 2;
        }
        
        .card-definition:hover {
            transform: scale(1.1);
            color: var(--primary-color);
        }

        /* 默认提示/使用说明样式 */
        .instructions-content strong {
            color: var(--primary-color);
        }

        /* AI 正在思考气泡样式 */
        .loading-bubble {
            background-color: var(--user-bubble-bg);
            color: var(--text-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            font-size: 1.05rem;
        }
        
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            animation: dotFade 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* 3. 底部搜索输入框 - 应用更大的圆角并调整间距 */
        .input-footer {
            position: fixed;
            bottom: 20px; 
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px); 
            max-width: var(--max-content-width);
            background-color: var(--ai-bubble-bg);
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            padding: 15px 0 20px; 
            border-radius: var(--floating-radius); 
            box-shadow: var(--soft-shadow); 
            z-index: 100;
            border: 1px solid var(--border-color); 
        }

        .input-group-wrapper {
            width: 100%;
            max-width: var(--max-content-width);
            margin: 0 auto;
            padding: 0 25px;
            display: flex; 
            flex-direction: column;
            align-items: center;
        }
        
        .input-group {
            width: 100%;
            height: var(--input-height);
            border-radius: var(--floating-radius); 
            border: 2px solid var(--border-color); 
            display: flex;
            align-items: center;
            background: var(--card-bg); 
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.18); 
        }
        
        #character-input {
            flex-grow: 1;
            border: none;
            padding: 0 20px;
            font-size: 1.5rem;
            outline: none;
            background: transparent;
            color: var(--text-color);
            font-weight: normal;
        }
        
        .search-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            /* 修正：取消固定宽度，让内容决定宽度，并增加 padding 确保可点击区域 */
            width: auto; 
            padding: 0 20px; 
            height: 100%;
            cursor: pointer;
            font-size: 1.4rem;
            transition: color var(--transition-speed) ease;
            /* 确保在输入框内部居中对齐 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-btn:hover {
            color: var(--accent-color);
        }

        /* 版权信息样式 */
        .copyright-info {
            margin-top: 8px; 
            font-size: 0.75rem;
            color: var(--light-text);
            text-align: center;
        }

        /* 4. 复制通知 */
        .copy-notification {
            position: fixed;
            bottom: -50px; 
            left: 50%;
            transform: translateX(-50%); 
            opacity: 0;
            background: rgba(0,0,0,0.85); 
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: bottom 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease; 
            z-index: 1000;
        }
        
        .copy-notification.show {
            bottom: calc(var(--input-height) + 50px);
            opacity: 1;
        }

        /* 5. 动画和响应式 */
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes dotFade {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }


        @media (max-width: 900px) {
            .message-bubble {
                padding: 20px 15px;
            }
            .input-footer {
                bottom: 10px; 
                width: calc(100% - 30px); 
                padding: 15px 0 15px; 
            }
            /* 修正：在移动端减少输入区域的左右内边距，使其更贴近屏幕边缘 */
            .input-group-wrapper {
                padding: 0 10px; /* 原为 15px，改为 10px 或更少 */
            }
             .copy-notification.show {
                bottom: calc(var(--input-height) + 30px);
            }
        }
        
        @media (max-width: 576px) {
            /* 移动端卡片宽度修正 */
            .cards-container { 
                grid-template-columns: repeat(auto-fill, minmax(75px, 75px)); 
                gap: 12px; 
            } 
            .card {
                 height: 110px; 
            }
             .card-character { font-size: 2.3rem; }
            .copyright-info {
                font-size: 0.7rem;
            }
            /* 修正：在小屏幕上再次减少 padding */
            .input-group-wrapper {
                padding: 0 8px; 
            }
        }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="header-logo">
            <img src="https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/LU5q/538X150/1.png/webp" alt="字造Logo">
        </div>
        <div class="header-actions">
            <button class="action-button" id="clear-chat-btn" aria-label="清空聊天记录" title="清空聊天记录">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button class="action-button" id="dark-mode-btn" aria-label="切换主题" title="切换主题">
                <i class="fas fa-sun" id="dark-mode-icon"></i>
            </button>
        </div>
    </header>

    <main class="chat-container" id="chat-container">
    </main>

    <footer class="input-footer">
        <div class="input-group-wrapper">
            
            <div class="input-group">
                <input type="text" id="character-input" maxlength="1" placeholder="输入一个汉字查询形近字" autocomplete="off" aria-label="输入汉字进行查询">
                <button id="search-btn" class="search-btn" aria-label="搜索">
                    <svg class="icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 458.6c12.5 12.5 12.5 32.75 0 45.25s-32.75 12.5-45.25 0L330.7 376c-34.46 25.12-76.81 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c88.37 0 160-71.63 160-160S296.3 32 208 32S48 103.6 48 192S119.6 352 208 352z"/></svg>
                </button>
            </div>
            
            <div class="copyright-info">
                © 2025 自在造字Zizao.top. 版权所有.
            </div>
            
        </div>
    </footer>
    
    <div class="copy-notification" id="copy-notification">已复制到剪贴板</div>

<script src="data.js"></script>
    
<script>
    // 定义本地头像图片路径
    const USER_AVATAR_URL = "https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/11ox/300X300/2.png/webp"; 
    const SYSTEM_AVATAR_URL = "https://tc-new.z.wiki/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251004/hafo/1250X1250/1.png/webp";
    
    const DOM = {
        characterInput: document.getElementById('character-input'),
        searchBtn: document.getElementById('search-btn'),
        chatContainer: document.getElementById('chat-container'),
        copyNotification: document.getElementById('copy-notification'),
        darkModeBtn: document.getElementById('dark-mode-btn'), 
        darkModeIcon: document.getElementById('dark-mode-icon'), 
        clearChatBtn: document.getElementById('clear-chat-btn')
    };
    
    const definitionBaseUrl = "https://www.zdic.net/hans/%s";
    let copyTimeout = null; 
    let currentLoadingMessageId = null; 
    
    // 主题状态管理
    const THEME_KEY = 'appTheme';
    let currentTheme = 'light-default'; 
    const THEME_CYCLE = ['light-default', 'light-eye-care', 'dark'];
    
    // 聊天记录存储键
    const CHAT_HISTORY_KEY = 'chatHistory';
    
    let wordMap = new Map();
    function preprocessData() {
        if (typeof customWordGroups !== 'undefined') {
            customWordGroups.forEach(wordGroup => {
                const firstChar = wordGroup.charAt(0);
                if (!wordMap.has(firstChar)) {
                    wordMap.set(firstChar, new Set());
                }
                const relatedSet = wordMap.get(firstChar);
                for (let i = 0; i < wordGroup.length; i++) {
                    relatedSet.add(wordGroup.charAt(i));
                }
            });
        } else {
            console.error("数据加载失败。请检查 data.js 文件是否正确引入。");
        }
    }
    
    // 确保滚动到页面最底部
    function scrollToBottom() {
        setTimeout(() => {
            window.scrollTo({
                top: document.documentElement.scrollHeight, 
                behavior: 'smooth'
            });
        }, 100);
    }
    
    // --- 聊天记录存储与加载函数 ---

    function loadChatHistory() {
        try {
            const history = localStorage.getItem(CHAT_HISTORY_KEY);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.error("加载聊天历史失败:", e);
            return [];
        }
    }

    function saveChatHistory(history) {
        try {
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
            console.error("保存聊天历史失败:", e);
        }
    }
    
    /**
     * 将消息添加到 DOM 并保存到历史记录
     * @param {string} type - 'user' 或 'system'
     * @param {string} contentHtml - 消息的 HTML 内容
     * @param {boolean} isTransient - 是否为临时消息 (如 Loading)
     * @param {string} [id] - 消息 ID
     */
    function addMessageToDOMAndHistory(type, contentHtml, id = null, isTransient = false) {
        const messageElement = createMessage(type, contentHtml, id, isTransient);
        DOM.chatContainer.appendChild(messageElement);
        
        // 只有非临时消息才保存到历史记录
        if (!isTransient) {
            const history = loadChatHistory();
            // 如果不是替换加载消息，且不是说明消息，则添加到历史记录
            if (!messageElement.classList.contains('loading-msg') && id !== 'msg-instructions') {
                history.push({ type, contentHtml, id: messageElement.id });
                saveChatHistory(history);
            }
        }
        
        return messageElement;
    }
    
    /**
     * 创建消息气泡的通用函数 (仅创建 DOM 元素)
     */
    function createMessage(type, contentHtml, id = null, isTransient = false) {
        const messageElement = document.createElement('div');
        const msgId = id || 'msg-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        messageElement.id = msgId;
        
        messageElement.classList.add('message-bubble', `${type}-bubble`);
        if (isTransient) {
            messageElement.classList.add('loading-msg');
        }

        const avatarUrl = type === 'user' ? USER_AVATAR_URL : SYSTEM_AVATAR_URL;
        
        messageElement.innerHTML = `
            <div class="message-content-wrapper">
                <div class="message-icon">
                     <img src="${avatarUrl}" alt="${type === 'user' ? '用户' : '系统'}头像">
                </div>
                <div class="bubble-content">${contentHtml}</div>
            </div>
        `;
        return messageElement;
    }

    function addUserMessage(char) {
        const content = `查询汉字：<strong style="font-size: 1.2em;">${char}</strong>`;
        addMessageToDOMAndHistory('user', content);
    }

    function addLoadingMessage() {
        const loadingHtml = `
            <div class="loading-bubble">
                字菌 正在努力查询中
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        `;
        const messageId = 'msg-loading-' + Date.now();
        addMessageToDOMAndHistory('system', loadingHtml, messageId, true);
        currentLoadingMessageId = messageId; 
        
        scrollToBottom(); 
        return messageId;
    }

    function removeOrReplaceLoadingMessage(contentHtml) {
        const loadingMsg = document.getElementById(currentLoadingMessageId);
        
        if (loadingMsg) {
            let history = loadChatHistory();
            const historyIndex = history.findIndex(msg => msg.id === currentLoadingMessageId);
            
            if (contentHtml) {
                // 替换内容
                loadingMsg.classList.remove('loading-msg');
                // 使用 createMessage 生成结构，确保 innerHTML 被正确替换
                loadingMsg.innerHTML = createMessage('system', contentHtml).innerHTML; 
                
                // 更新历史记录
                if (historyIndex !== -1) {
                    history.splice(historyIndex, 1, { 
                        type: 'system', 
                        contentHtml: contentHtml, 
                        id: currentLoadingMessageId 
                    });
                } else {
                    history.push({ 
                        type: 'system', 
                        contentHtml: contentHtml, 
                        id: currentLoadingMessageId 
                    });
                }
                saveChatHistory(history);

            } else {
                // 移除消息
                loadingMsg.remove();
                // 从历史记录中移除
                if (historyIndex !== -1) {
                    history.splice(historyIndex, 1);
                    saveChatHistory(history);
                }
            }
        } else if (contentHtml) {
            // 如果加载消息不存在，但有内容，则直接作为系统消息添加
            addSystemMessage(contentHtml);
        }
        currentLoadingMessageId = null;
        scrollToBottom(); 
    }

    function addSystemMessage(contentHtml) {
        addMessageToDOMAndHistory('system', contentHtml);
    }

    /**
     * 渲染默认的使用说明 - 确保它是第一个元素
     */
    function renderDefaultInstructions() {
        const instructionsHtml = `
            <div class="instructions-content" style="padding: 0;">
                <h2 class="results-title" style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                    <i class="fas fa-info-circle"></i>
                    使用说明
                </h2>
                <ol style="padding-left: 20px; margin-top: 5px; list-style-type: decimal; color: var(--light-text); font-size: 0.95rem;">
                    <li style="margin-bottom: 12px;">在底部输入框输入<strong style="color: var(--accent-color);">单个汉字</strong>，按回车或点击搜索按钮进行查询。</li>
                    <li style="margin-bottom: 12px;">每个形近字以卡片形式展示，点击卡片可复制该汉字。</li>
                    <li style="margin-bottom: 12px;">卡片下方显示该字在GB2312编码排序中的位置和页码信息。</li>
                    <li style="margin-bottom: 12px;">点击卡片右上角的信息图标可在新标签页中查看该字的详细释义。</li>
                    <li style="margin-bottom: 12px;">本页面数据由字造整理，当前包含国标GB2312全部中文字符。</li>
                </ol>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.9rem;">
                    <span style="color: var(--light-text); margin-right: 15px;">推荐:</span>
                    <a href="https://www.zizao.top" target="_blank" style="color: var(--primary-color); text-decoration: none; margin-right: 5px;">字造首页</a> |
                    <a href="https://www.zizao.top/hao" target="_blank" style="color: var(--primary-color); text-decoration: none; margin-left: 5px; margin-right: 5px;">设计导航</a>
                </div>
            </div>
        `;
        // 1. 检查是否已存在，防止重复添加
        if (document.getElementById('msg-instructions')) return; 

        // 2. 创建消息元素
        const msgElement = createMessage('system', instructionsHtml, 'msg-instructions', false);
        msgElement.classList.add('instructions-msg'); 
        
        // 3. 附加到容器中
        DOM.chatContainer.appendChild(msgElement);
    }

    // 从历史记录渲染消息到 DOM
    function renderChatHistory() {
        const history = loadChatHistory();
        DOM.chatContainer.innerHTML = ''; // 清空所有内容
        
        // 1. 始终渲染使用说明作为第一个元素
        renderDefaultInstructions();

        // 2. 渲染历史记录（历史记录会追加到说明之后）
        if (history.length > 0) {
            history.forEach(msg => {
                const messageElement = createMessage(msg.type, msg.contentHtml, msg.id, false);
                DOM.chatContainer.appendChild(messageElement);
            });
        }
        
        scrollToBottom();
    }
    
    function showLoading() {
        // 使用 Font Awesome 搜索图标替换为加载中的 spinner 动画
        DOM.searchBtn.innerHTML = '<svg class="icon loading-spinner" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="animation: spin 1.5s linear infinite;"><path d="M448 256c0-106-86-192-192-192V32C375.7 32 480 136.3 480 264c0 13.25-10.75-24-24 24s-24-10.75-24-24C432 153.8 342.2 64 232 64v48c-106 0-192 86-192 192s86 192 192 192c47.94 0 91.22-17.75 125.7-47.5c18.5-16 45.19-14.5 61.19 4s14.5 45.19-4 61.19C340.3 499.7 299.1 512 256 512C114.6 512 0 397.4 0 256S114.6 0 256 0c13.25 0 24 10.75 24 24S269.3 48 256 48z"/></svg>';
        DOM.searchBtn.disabled = true;
        DOM.characterInput.disabled = true;
    }

    function hideLoading() {
        // 恢复 Font Awesome 搜索图标
        DOM.searchBtn.innerHTML = '<svg class="icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 458.6c12.5 12.5 12.5 32.75 0 45.25s-32.75 12.5-45.25 0L330.7 376c-34.46 25.12-76.81 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c88.37 0 160-71.63 160-160S296.3 32 208 32S48 103.6 48 192S119.6 352 208 352z"/></svg>';
        DOM.searchBtn.disabled = false;
        DOM.characterInput.disabled = false;
    }


    async function searchCharacters(isFromUrl = false) {
        
        const inputChar = DOM.characterInput.value.trim();

        if (inputChar.length !== 1 || !/^[\u4e00-\u9fa5]$/.test(inputChar)) {
             if (!isFromUrl && inputChar.length > 0) {
                addUserMessage(inputChar);
                const errorHtml = `
                    <div class="no-results" style="text-align: center; color: var(--light-text); font-size: 1.0rem; line-height: 1.8; padding: 20px 0;">
                        ${inputChar.length > 1 ? '请输入**单个汉字**进行查询。' : '请输入**有效的汉字**。'}
                    </div>
                `;
                addSystemMessage(errorHtml);
            }
            DOM.characterInput.value = '';
            DOM.characterInput.focus();
            return;
        }

        if (!isFromUrl) {
            addUserMessage(inputChar);
        }
        
        DOM.characterInput.value = '';
        showLoading();

        addLoadingMessage();
        // 模拟网络延迟 500ms
        await new Promise(resolve => setTimeout(resolve, 500)); 

        const relatedCharsSet = wordMap.get(inputChar) || new Set();
        relatedCharsSet.delete(inputChar);
        let relatedChars = Array.from(relatedCharsSet);
        
        // 将查询字作为第一个元素添加
        if (wordMap.has(inputChar)) {
            relatedChars.unshift(inputChar);
        }

        let finalContentHtml = '';
        const pageSize = 500; 
        
        if (relatedChars.length === 0) {
            finalContentHtml = `
                <div class="no-results" style="text-align: center; color: var(--light-text); font-size: 1.0rem; line-height: 1.8; padding: 20px 0;">
                    抱歉，未找到“<strong style="color: var(--primary-color);">${inputChar}</strong>”的形近字。<br>
                    建议尝试查询“<strong style="color: var(--accent-color);">字</strong>”、“<strong style="color: var(--accent-color);">设</strong>”、“<strong style="color: var(--accent-color);">计</strong>”等常用字。
                </div>
            `;
        } else {
            const cardsHtml = relatedChars.map((char) => {
                // 假设 indexGroup 包含所有字的顺序索引
                const firstPosition = typeof indexGroup !== 'undefined' ? indexGroup.indexOf(char) + 1 : -1;
                const totalPosition = firstPosition > 0 ? firstPosition : '';
                // 计算页码 (每页 500 个字)
                const pagePosition = firstPosition > 0 ? `${Math.floor((firstPosition - 1) / pageSize) + 1}/${(firstPosition - 1) % pageSize + 1}` : '';
                
                return `
                    <div class="card" data-char="${char}">
                        <button class="card-definition" title="查看释义">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <div class="card-character">${char}</div>
                        <div class="card-positions-wrapper" title="总序/页码">
                            <div class="card-position-total">${totalPosition}</div>
                            <div class="card-position-page">${pagePosition}</div>
                        </div>
                    </div>
                `;
            }).join('');

            finalContentHtml = `
                <header class="results-header">
                    <h2 class="results-title">
                        <i class="fas fa-link"></i>
                         “${inputChar}”的形近字
                    </h2>
                    <div class="results-count">${relatedChars.length}个结果</div>
                </header>
                <div class="cards-container">${cardsHtml}</div>
            `;
        }
        
        removeOrReplaceLoadingMessage(finalContentHtml);
        
        updateUrl(inputChar);
        
        hideLoading();
        DOM.characterInput.focus(); 
    }

    function updateUrl(char) {
        const newUrl = new URL(window.location.href);
        if (char && char.length === 1 && /^[\u4e00-\u9fa5]$/.test(char)) {
            newUrl.searchParams.set('char', char);
        } else {
            newUrl.searchParams.delete('char');
        }
        window.history.pushState({ path: newUrl.href }, '', newUrl.href);
    }

    function copyToClipboard(text) {
        if (copyTimeout) {
            clearTimeout(copyTimeout);
        }
        
        DOM.copyNotification.classList.remove('show');

        navigator.clipboard.writeText(text)
            .then(() => {
                DOM.copyNotification.classList.add('show');
                
                copyTimeout = setTimeout(() => {
                    DOM.copyNotification.classList.remove('show');
                    copyTimeout = null;
                }, 1500); 
            })
            .catch(err => {
                console.error('无法复制文本: ', err);
                alert('复制失败，请手动复制。');
            });
    }
    
    // 主题切换函数 - 逻辑加强
    function applyTheme(theme) {
        currentTheme = theme;
        const bodyClassList = document.body.classList;
        
        // 移除所有主题相关的 class
        bodyClassList.remove('dark-mode', 'eye-care-mode');
        
        let nextThemeIndex = (THEME_CYCLE.indexOf(theme) + 1) % THEME_CYCLE.length;
        let nextTheme = THEME_CYCLE[nextThemeIndex];
        let nextIconClass = '';
        let nextTitle = '';

        if (theme === 'dark') {
            bodyClassList.add('dark-mode');
            nextIconClass = 'fa-sun'; // 下一个状态是 默认浅色
            nextTitle = '切换到默认浅色模式';
        } else if (theme === 'light-eye-care') {
            bodyClassList.add('eye-care-mode');
            nextIconClass = 'fa-moon'; // 下一个状态是 深色
            nextTitle = '切换到深色模式';
        } else { // light-default
            nextIconClass = 'fa-leaf'; // 下一个状态是 浅绿色护眼
            nextTitle = '切换到浅绿色护眼模式';
        }

        // 更新按钮图标和提示
        DOM.darkModeIcon.className = 'fas ' + nextIconClass;
        DOM.darkModeBtn.setAttribute('title', nextTitle);
        DOM.darkModeBtn.setAttribute('aria-label', nextTitle);
        
        localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme() {
        const currentIndex = THEME_CYCLE.indexOf(currentTheme);
        const nextIndex = (currentIndex + 1) % THEME_CYCLE.length;
        const nextTheme = THEME_CYCLE[nextIndex];
        applyTheme(nextTheme);
    }
    
    function clearChat() {
        if (confirm('确定要清空所有搜索记录吗？')) {
            DOM.chatContainer.innerHTML = '';
            localStorage.removeItem(CHAT_HISTORY_KEY); // 清空本地存储
            // 清空后重新渲染说明
            renderDefaultInstructions();
            updateUrl('');
            DOM.characterInput.focus();
        }
    }

    // --- 事件监听器 ---

    // 使用事件委托处理卡片点击 (复制和释义)
    DOM.chatContainer.addEventListener('click', (event) => {
        const target = event.target;
        const card = target.closest('.card');
        if (card) {
            const char = card.dataset.char;
            // 检查是否点击了释义按钮（fa-info-circle 或其父级 button）
            if (target.closest('.card-definition')) {
                event.stopPropagation();
                window.open(definitionBaseUrl.replace('%s', char), '_blank');
            } else {
                // 点击卡片主体部分，执行复制
                copyToClipboard(char);
            }
        }
    });

    // 搜索事件
    DOM.searchBtn.addEventListener('click', () => searchCharacters());
    DOM.characterInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') searchCharacters();
    });
    
    // 主题模式切换按钮
    DOM.darkModeBtn.addEventListener('click', toggleTheme);
    
    // 清空聊天按钮
    DOM.clearChatBtn.addEventListener('click', clearChat);


    // --- 初始化 ---

    document.addEventListener('DOMContentLoaded', () => {
        preprocessData();
        
        // 恢复主题
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light-default';
        applyTheme(savedTheme);

        // 初始化时加载聊天历史 (现在保证说明消息始终是第一个元素)
        renderChatHistory();

        // 处理 URL 参数中的查询
        const urlChar = new URLSearchParams(window.location.search).get('char');
        if (urlChar && urlChar.length === 1 && /^[\u4e00-\u9fa5]$/.test(urlChar)) {
            // 如果 URL 中有参数，检查历史记录是否包含该字的查询记录
            const history = loadChatHistory();
            const alreadySearched = history.some(msg => msg.type === 'user' && msg.contentHtml.includes(`>${urlChar}<`));

            if (!alreadySearched) {
                 DOM.characterInput.value = urlChar; 
                 searchCharacters(true);
            } else {
                 DOM.characterInput.focus();
            }
        } else {
            DOM.characterInput.focus();
        }
    });
</script>
</body>
</html>